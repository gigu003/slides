---
title: "canregtools"
subtitle: "An R package used in PBCRs"
author: "ğŸ‘¨â€âš•ï¸Qiong Chen Phd."
date: 2024-4-11
date-modified: last-modified
date-format: "dddd MMM D, YYYY"
institute: "ğŸ¥æ²³å—çœç™Œç—‡ä¸­å¿ƒ\næ²³å—çœè‚¿ç˜¤åŒ»é™¢"
format:
  pptx: default
  revealjs:
    slide-number: true
    scrollable: false
    sc-sb-title: h1
    footer: "https://slides.chenq.site"
revealjs-plugins:
  - attribution
filters:
   - reveal-header
   - reveal-auto-agenda
auto-agenda:
  bullets: numbered
  heading: ä¸»è¦å†…å®¹
title-slide-attributes:
  data-background-color: "lightblue"
categories: ["è‚¿ç˜¤ç™»è®°", "Rè¯­è¨€"]
address: "å‘¼å’Œæµ©ç‰¹"
---

## å®é™…éœ€æ±‚

<br>

> è‚¿ç˜¤ç™»è®°æ˜¯æˆ‘å›½æ¶æ€§è‚¿ç˜¤ç›‘æµ‹çš„ä¸€é¡¹å¸¸è§„å·¥ä½œå†…å®¹ï¼Œå®ƒå®šæœŸæ”¶é›†äººç¾¤ä¸­æ¶æ€§è‚¿ç˜¤å‘ç—…ã€æ­»äº¡åŠç”Ÿå­˜æ•°æ®å¹¶è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œä»è€Œä¸ºè‚¿ç˜¤é˜²æ§å·¥ä½œæä¾›å‚è€ƒæ•°æ®ã€‚

<br>

- è´¨é‡æ§åˆ¶ï¼ˆäº”å¤§æ´²å‘ç—…ç‡ã€å¹´åº¦æ•°æ®è´¨é‡å®¡æ ¸ï¼‰
- ç»Ÿè®¡åˆ†æï¼ˆç²—ç‡ã€æ ‡åŒ–ç‡ç­‰ï¼‰
- æ’°å†™æŠ¥å‘Šï¼ˆè‚¿ç˜¤ç™»è®°å¹´æŠ¥ï¼‰
- ç§‘æŠ€è®ºæ–‡

:::{.callout-important}
## ç¼ºå°‘å·¥å…·
ç›®å‰è¿˜æ²¡æœ‰ä¸€æ¬¾å…¬å¼€å‘å¸ƒçš„è‚¿ç˜¤ç™»è®°æ•°æ®åˆ†æå·¥å…·æ¥æ–¹ä¾¿å¿«æ·çš„å®ç°ä¸Šè¿°åŠŸèƒ½ã€‚
:::


## è½¯ä»¶å¹³å°é€‰æ‹©

<br>

> *Rè¯­è¨€*æ˜¯ä¸€ç§ç”¨äºç»Ÿè®¡åˆ†æå’Œæ•°æ®å¯è§†åŒ–çš„ç¼–ç¨‹è¯­è¨€å’Œç¯å¢ƒã€‚å®ƒæ˜¯ä¸€ä¸ªå¼€æºçš„ã€å…è´¹çš„è½¯ä»¶ï¼Œå¹¿æ³›ç”¨äºç»Ÿè®¡å­¦ã€æ•°æ®åˆ†æã€æ•°æ®æŒ–æ˜å’Œç”Ÿç‰©ä¿¡æ¯å­¦ç­‰é¢†åŸŸã€‚

<br>

```{mermaid}
%%| label: fig-1
%%| fig-cap: è½¯ä»¶å¹³å°é€‰æ‹©
%%| fig-align: center
flowchart TD
  A[(å·¥å…·)] --> B(Rè¯­è¨€)
  A --> C(SAS)
  A --> D(SPSS)
  A --> E(STATA)
  A --> F(Python)
```


## è½¯ä»¶å¹³å°é€‰æ‹©
<br>

:::: {.columns}

::: {.column width="50%"}
- å…è´¹
- ä¾¿äºåˆ†äº«(CRAN, github)
- RåŒ…
- è·¨å¹³å°(Windowsã€macOSã€Linuxã€unix)
:::

::: {.column width="50%"}
![](images/r-packages.png)

:::

::::


## åŠŸèƒ½è®¾è®¡


```{mermaid}

%%| fig-align: center
flowchart TD
  A[(è‚¿ç˜¤ç™»è®°RåŒ…)] --> B(æ•°æ®è¯»å…¥ä¸è½¬æ¢)
  A --> C(æ•°æ®å¤„ç†)
  A --> D(è´¨é‡æ§åˆ¶)
  A --> E(ç»Ÿè®¡åˆ†æ)
  A --> F(å¯è§†åŒ–)
  A --> G(æŠ¥è¡¨)
  B --> b1(å¸¸è§„æŠ¥å‘Š)
  B --> b2(å¯¿å‘½è¡¨)
  C --> c1(æ ‡å‡†è½¬æ¢)
  C --> c2(åˆ†ç±»)
  C --> c3(è¯­ç§)
  C --> c4(äººå£æ•°æ®)
  
```


:::: {.columns}

::: {.column width="50%"}
```{mermaid}
%%| fig-align: center
flowchart TD
  A[(ç»Ÿè®¡åˆ†æ)] --> B(ç»Ÿè®¡è®¡ç®—)
  A --> C(ç»Ÿè®¡å­¦æ£€éªŒ)
  B --> b1(å¯¿å‘½è¡¨)
  B --> b2(æˆªç¼©ç‡)
  B --> b3(æ ‡åŒ–ç‡)
  B --> b4(å¹´é¾„åˆ«ç‡)
```
:::

::: {.column width="50%"}
```{mermaid}
%%| fig-align: center
flowchart TD
  A[(å¯è§†åŒ–)] --> B(äººå£é‡‘å­—å¡”)
  A --> C(çº¿å›¾)
  A --> D(åŒå‘æ¡å½¢å›¾)
  A --> E(ç«ç‘°å›¾)
  A --> F(å“‘é“ƒå›¾)
  A --> G(ç™Œç—‡åœ°å›¾)
```
:::

::::

## åŒ…çš„å®‰è£…

å¯ä»¥é€šè¿‡devtoolså®‰è£…

```r
library(devtools)
install_github("gigu003/canregtools")
```

![](images/github.jpg)

ä¹Ÿå¯ä»¥é€šè¿‡remotesåŒ…è¿›è¡Œå®‰è£…

```r
install.packages("remotes")
library(remotes)
install_github("gigu003/canregtoools")
```

## è¯»å–æ•°æ®

```{r}
#| echo: fenced
library(canregtools)
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
data
```

## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°

### å¹´é¾„é‡æ–°åˆ†ç»„--cutage()


cutage(
  x,
  
  method = "distance",
  
  length = 5,
  
  maxage = 85,
  
  sep_zero = TRUE,
  
  breaks = c(seq(0, 85, 5)),
  
  labels = NULL,
  
  lang = "cn",
  
  label_tail = NULL,
  
  right = FALSE
)


## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°

### å¹´é¾„é‡æ–°åˆ†ç»„--cutage()

::: {.panel-tabset}
## distanceæ–¹æ³•  
```{r}
#| echo: fenced
library(canregtools)
age <- sample(0:101, 200, replace = TRUE)
agegrp <- cutage(age, method = "distance", length = 5, maxage = 60, sep_zero = TRUE)
as.data.frame(table(agegrp))
```

## intervalæ–¹æ³•
```{r}
#| echo: fenced
library(canregtools)
age <- sample(0:101, 200, replace = TRUE)
agegrp <- cutage(age, method = "interval", breaks = seq(0, 85, 5),lang = "en")
as.data.frame(table(agegrp))
```
:::

## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°

### æ‰©å……äººå£æ•°æ®-- expand_age_pop()

<br>

expand_age_pop(x, method = "linear")

<br>

x	Vector, population for each age group.

method	Method for expanding, options are 'linear', 'constant', 'periodic',
or 'natural'. Default is 'linear'.


## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°

### æ‰©å……äººå£æ•°æ®-- expand_age_pop() 
```{r}
#| echo: fenced
#| output-location: slide 
age <- c(0, 1, seq(5, 85, 5))
pops <- c(5053, 17743, 25541, 32509, 30530, 34806, 36846, 38691, 40056,
   39252, 37349, 30507, 26363, 21684, 15362, 11725, 7461, 3260, 915)

pop <- pops
pop[2] <- pop[2]/4
pop[3:19] <- pop[3:19]/5
#æŠŠäººå£æ•°æ®ä»5å²ç»„æ‰©å……è‡³1å²ç»„
age2 <- expand_age_pop(pops)
#ç»˜åˆ¶æ‹Ÿåˆæ›²çº¿
par(family="STKaiti")
plot(age2, pch = 19, xlab= "å¹´é¾„ç»„", ylab = "äººå£æ•°", type = "l")
lines(age, pop, type = "p", col="red")
```


## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### ICDO3è½¬æ¢ICD10ç¼–ç 

```{r}
#| echo: fenced
topo <- c("C001", "C15.1", "C349")
morp <- c("8140", "8000", "8070")
beha <- rep("3", 3)
#icdo3to10(topo, morp, beha)
```

## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### è‚¿ç˜¤çš„åˆ†ç±»


```{r}
#| echo: fenced
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
icd10 <- data$FBcases$icd10
head(icd10)
```

## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### è‚¿ç˜¤çš„åˆ†ç±»-- classify_icd10

<br>

classify_icd10(icd10, cancer_type = "big", lang = "cn")

## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### è‚¿ç˜¤çš„åˆ†ç±»-- classify_icd10

::: {.panel-tabset}
## 26ç±»(ä¸­æ–‡)
```{r}
#| echo: fenced
c1 <- classify_icd10(icd10, cancer_type = "big", lang = "cn")
as.data.frame(table(c1))
```

## 59ç±»(è‹±æ–‡)
```{r}
#| echo: fenced
c1 <- classify_icd10(icd10, cancer_type = "small", lang = "en")
as.data.frame(table(c1))
```

## æŒ‰ç³»ç»Ÿåˆ†ç±»(ä¸­æ–‡)
```{r}
#| echo: fenced
c1 <- classify_icd10(icd10, cancer_type = "system", lang = "cn")
as.data.frame(table(c1))
```

:::


## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### å„¿ç«¥è‚¿ç˜¤çš„åˆ†ç±»-- classify_childhood

<br>

classify_childhood(topo, morp, type = "main", lang = "cn")


## å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°
### å„¿ç«¥è‚¿ç˜¤çš„åˆ†ç±»-- classify_childhood

```{r}
#| echo: fenced
fbcases <- data$FBcases
fbcases <- fbcases[fbcases$age <= 14,]

classify_childhood(fbcases$topo, fbcases$morp)

classify_childhood(fbcases$topo, fbcases$morp, type = "sub")
```


## counts

```{r}
#| echo: fenced
#| output-location: slide 
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
fbsw <- count_canreg(data, cutage_method = "interval")
fbsw
```

## å¹´é¾„åˆ«ç‡

```{r}
#| echo: fenced
create_age_rate(fbsw, event = sws, year, sex, icd_cat)
```

## è´¨é‡æ§åˆ¶æŠ¥è¡¨
```{r}
#| echo: fenced
create_quality(fbsw, year, sex)
```

```{r}
#| echo: fenced
create_quality(fbsw, year, sex, icd_cat)
```

## æ ‡åŒ–ç‡

```{r}
#| echo: fenced
asr_rate(data, year, sex, icd_cat, lang = "en" )
```

## æ ‡åŒ–ç‡

```{r}
#| echo: fenced
asr_rate(data, year, icd_cat, type = "system", lang = "en" )
```

## ç®€ç•¥å¯¿å‘½è¡¨

```{r}
#| echo: fenced
#| output-location: slide

px <- c(
  20005, 86920, 102502, 151494, 182932,
  203107, 240289, 247076, 199665, 163820,
  145382, 86789, 69368, 51207, 39112, 20509,
  12301, 6586, 1909
)
dx <- c(
  156, 58, 47, 49, 48, 68, 120, 162, 160, 294,
  417, 522, 546, 628, 891, 831, 926, 731, 269
)
mx <- dx / px

lt <- lt(mx, sage = 0, agegrp = 5, sex = "total")
lt$ex <- round(lt$ex, 2)
lt
```

## ç®€ç•¥å¯¿å‘½è¡¨-->å®Œå…¨å¯¿å‘½è¡¨
```{r}
#| echo: fenced
lx <- c(
  100000, 99498.39, 99294.62, 99173.88, 99047.59, 98840.46,
  98521.16, 98161.25, 97636.99, 96900.13, 95718.96, 93930.91,
  91463.21, 87131.41, 80525.02, 70907.59, 58090.75, 41630.48,
  24019.33
)
lx <- lx / 100000
expand_lifetable(lx)
```

## äººå£é‡‘å­—å¡”å›¾

```{r}
#| echo: fenced
#| output-location: slide
#| fig-height: 6
left <- c(
  5053, 17743, 25541, 32509, 30530, 34806, 36846, 38691, 40056,
  39252, 37349, 30507, 26363, 21684, 15362, 11725, 7461, 3260, 915
)
right <- c(
  4728, 15330, 22633, 27784, 28082, 32605, 32964, 35732, 36234,
  37123, 34242, 29152, 24667, 18940, 15406, 12355, 10206, 5634,
  2547
)
agegrp <- c(
  "0", "1-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34",
  "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69",
  "70-74", "75-79", "80-84", "85+"
)
pop <- data.frame(left = left, right = right, row.names = agegrp)
par(family="STKaiti", mar=c(0,0,0,0))
pyramid(pop, main = "Population pyramid in China.", csize = 0.8, cgap = 0.3)
```

## åŒå‘æ¡å½¢å›¾
```{r}
#| echo: fenced
#| output-location: slide
#| fig-height: 5
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
rate <- asr_rate(data, icd_cat, event = sws)
par(family="STKaiti", mar=c(0,0,0,0))
dulbar_chart(rate[,c(1, 3, 6, 9, 10)])
```

## çº¿å›¾

```{r}
#| echo: fenced
#| output-location: slide
#| fig-height: 5
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
fbsw <- count_canreg(data)
age <- create_age_rate(fbsw, sex, event = sws)
par(family="STKaiti", mar=c(0,0,0,0))
line_chart(age, agegrp, rate, sex)
```


## å“‘é“ƒå›¾

```{r}
#| echo: fenced
#| output-location: slide
#| fig-height: 5
file <- system.file("extdata", "411721.xls", package = "canregtools")
data <- read_canreg(file)
rate <- asr_rate(data,icd_cat)
par(family="STKaiti", mar=c(0,0,0,0))
dumbbell_chart(rate, icd_cat, cr_lower, cr_upper)
```

## ä¸‹ä¸€æ­¥è®¡åˆ’

<br>

- ç™»è®°å¤„åˆå¹¶è¿ç®—åŠŸèƒ½
- åŸºäºRmarkdownå¹´åº¦æŠ¥å‘Šæ’°å†™æ¨¡æ¿
- åŸºäºRmarkdownè´¨é‡æ§åˆ¶æŠ¥å‘Šæ¨¡æ¿
- ç»Ÿè®¡åœ°å›¾åŠŸèƒ½
- è‚¿ç˜¤ç™»è®°è´¨é‡æ§åˆ¶ç›‘æµ‹é¢æ¿

##  {background-image="images/canregtools.jpg"}

<br>

<br>

<br>

[åœ°å€ï¼šhttps://gigu003.github.io/canregtools/](https://gigu003.github.io/canregtools/)

# è°¢ è°¢ å…³ æ³¨ ! {background-color="lightblue"  style="text-align: center;color: white;"}

é™ˆ ç¼ åšå£«

chenq08@126.com

https:://www.chenq.site/qsight/
