{
  "hash": "b158851ee1dc78b4194ca59cf09adfaa",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"肿瘤登记数据的统计分析和自动化报告\"\nsubtitle: \"Report cancer registration data using a developed R package canregtools\"\nauthor: \"陈琼\"\ndate: 2024-10-28\ndate-modified: last-modified\ndate-format: \"dddd MMM D, YYYY\"\ninstitute: \"河南省癌症中心/河南省肿瘤医院\"\naddress: \"南京\"\nformat:\n  canhosp-revealjs:\n    slide-number: true\n    scrollable: true\n    smaller: true\n    sc-sb-title: h1\n    highlight-style: dracula\n    footer: \"R包: canregtools\"\nrevealjs-plugins:\n  - attribution\nfilters:\n   - reveal-header\n   - reveal-auto-agenda\nauto-agenda:\n  bullets: numbered\n  heading: 内容\ncategories: [\"肿瘤登记\", \"R语言\"]\n---\n\n\n\n# canregtools 初衷\n## 人群肿瘤登记数据分析\n> 肿瘤登记是对肿瘤流行情况、趋势变化和影响因素进行长期、连续、动态的系统性监测，是制定癌症防治策略、开展综合研究、评价防控效果的重要基础性工作。\n\n- 个案数据内部一致性审核\n- 总体数据质量控制（CI5，年度审核）\n- 统计指标计算\n- 数据可视化\n- 报告\n\n## 现有工具有哪些？\n\n- IARCcrgTools\n- JRC tools\n- Canreg5\n- SEER*Stat\n- 其他软件或语言： R, SAS, STATA, Python\n\n\n\n# Canregtools 功能概述\n\n## Canregtools能做什么 ?\n<img src=\"images/logo_canregtools.png\" align=\"right\" height=\"120\" />\n \n> Canregtools 是一个旨在使肿瘤登记数据的分析、可视化和报告更加顺畅和高效的 R 语言包。它通过一系列R函数实现数据读取、数据处理、统计计算、可视化和报告等功能，全面支持 R 环境中的工作流程。\n\n:::: {.columns}\n\n::: {.column width=\"33%\"}\n#### 数据处理\n- cutage()\n- expand_age_pop()\n- classify_icd10()\n- classify-childhood()\n- tidy_*()\n- write_*()\n:::\n\n::: {.column width=\"33%\"}\n#### 统计计算\n- ageadjust()\n- truncrate()\n- cumrate()\n- cumrisk()\n- lt()\n- expand_lifetable()\n:::\n\n::: {.column width=\"33%\"}\n#### 统计表单\n- summary()\n- create_asr()\n- create_quality()\n- create_age_rate()\n- create_sheet()\n:::\n\n::::\n\n## Canregtools能做什么 ?\n> Canregtools 是一个为不同级别肿瘤登记处设计的工具。它支持批量处理来自多个登记处的数据，允许用户根据自定义条件筛选数据，并根据登记处属性重新格式化或合并肿瘤登记数据。\n\n:::: {.columns}\n\n::: {.column width=\"33%\"}\n#### 编辑肿瘤登记处属性\n- write_registry()\n- write_areacode()\n- write_area_type()\n- tidy_areacode()\n:::\n\n::: {.column width=\"33%\"}\n#### 筛选与合并\n- cr_select()\n- cr_merge()\n- reframe_fbswicd()\n:::\n\n::: {.column width=\"33%\"}\n#### 统计表单\n- summary()\n- create_asr()\n- create_quality()\n- create_age_rate()\n- create_sheet()\n:::\n\n::::\n\n\n## 定义S3类、泛函数\n\n> 我们定义了一组不同的类，通过泛函数对于不同的类执行不同的函数功能。\n\n:::: {.columns}\n\n::: {.column width=\"50%\"}\n#### 单登记处S3类\n- canreg\n- fbswicd\n- asr\n- quality\n- ...\n\n:::\n\n::: {.column width=\"50%\"}\n#### 多登记处S3类\n- canregs\n- fbswicds\n- asrs\n- qualities\n- ...\n:::\n\n::::\n\n#### S3 泛函数\ncreate_asr, create_quality, create_age_rate, create_sheet, cr_select, cr_merge, reframe_fbswicd\n\n## 内部一致性审核\n\n> 内部一致性检查是进行数据分析之前的关键步骤。我们需要识别并处理任何不可能或不太可能的变量组合，以确保数据的有效性。\n\n\n:::: {.columns}\n\n::: {.column width=\"33%\"}\n#### 检查单个变量\n- check_topo()\n- check_morp()\n- check_icd10()\n- check_areacode()\n- check_sex()\n- check_id()\n:::\n\n::: {.column width=\"33%\"}\n#### 检查变量组合\n- check_sex_morp()\n- check_sex_topo()\n- check_topo_morp()\n- check_morp_beha()\n- check_morp_grad()\n- check_age_topo_morp()\n:::\n\n::: {.column width=\"33%\"}\n#### 格式检查和转换\n- check_header()\n- check_followup()\n- ICDO3toICD10()\n:::\n\n::::\n\n\n\n## 安装前准备\n- [下载 R (Rhttps://cloud.r-project.org)](https://cloud.r-project.org)\n- [下载 Rstudio(https://posit.co/download/rstudio-desktop/)](https://posit.co/download/rstudio-desktop/)\n\n:::: {.columns}\n\n::: {.column width=\"50%\"}\n![](images/R.jpg)\n:::\n\n::: {.column width=\"50%\"}\n![](images/RStudio.jpg)\n:::\n\n::::\n\n## 如何安装 canregtools 包？\n> 目前canregtools包还处在功能不断完善阶段，还没有往CRAN正式提交，目前可以通过github安装或者本地文件安装。\n\n从github安装\n\n```r\n# install the remotes package if doesn't installed\ninstall.packages(\"remotes) \nlibrary(remotes)\ninstall_github(\"gigu003/canregtools\")\n```\n\n从本地编译文件安装\n\n```r\n# install the remotes package if doesn't installed\ninstall.packages(\"remotes) \nlibrary(remotes)\ninstall_local(\"canregtools_0.2.7.tar.gz\", type = \"source\")\n```\n\n\n\n\n# 单个肿瘤登记处\n## 数据读取(call for data，NCC)\n> Canregtools可以读取NCC call for data 格式原始数据，一个包含三个名为**FB**、**SW**和**POP**工作表的Excel文件，分别存储发病数据、死亡数据和人口数据。\n\n:::: {.columns}\n\n::: {.column width=\"60%\"}\n![](images/call_for_data.jpg)\n:::\n\n::: {.column width=\"30%\"}\n![](images/popu.jpg)\n:::\n\n::::\n\n\n## 读取原始数据为 canreg 类数据\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(canregtools)\nlibrary(dplyr)\nfiles <- list.files(\"~/website/slides/outputs\", full.names = TRUE)\nfile <- files[1]\ndata <- read_canreg(file)\nclass(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"canreg\" \"list\"  \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\" \"FBcases\"  \"SWcases\"  \"POP\"     \n```\n\n\n:::\n:::\n\n\n\n\n\n## canreg类数据对象 \n\n> \"canreg\" 是一个包含四个元素的列表，这些元素被命名为 'areacode'、'FBcases'、'SWcases' 和 'POP'，它们是从原始数据的 \"FB\"、\"SW\" 和 \"POP\" 工作表中读取的。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\" \"FBcases\"  \"SWcases\"  \"POP\"     \n```\n\n\n:::\n\n```{.r .cell-code}\ndata$areacode\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\"\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(data$FBcases)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 20\n  registr      sex   birthda    addcode trib  occu  marri inciden    topo  morp \n  <chr>        <chr> <date>     <chr>   <chr> <chr> <chr> <date>     <chr> <chr>\n1 21410500166… 1     1975-04-17 410102… 01    31    2     2021-10-26 C15.9 8010 \n2 21410802159… 2     1991-01-16 410102… 01    14    2     2021-10-22 C53.8 8140 \n3 21410102172… 2     1962-10-15 410102… 01    00    2     2021-01-19 C53.0 8070 \n4 21411202123… 2     1951-03-09 410102… 01    49    2     2021-01-30 C50.9 8000 \n5 21411624137… 1     1955-07-15 410102… 01    61    2     2021-05-13 C22.0 8000 \n6 23411002105… 1     1939-12-15 410102… 01    28    5     2021-12-22 C34.1 8140 \n# ℹ 10 more variables: beha <chr>, grad <chr>, basi <chr>, icd10 <chr>,\n#   autoicd10 <chr>, lastcontact <dttm>, status <chr>, caus <chr>,\n#   deathda <date>, deadplace <chr>\n```\n\n\n:::\n:::\n\n\n\n\n## canreg类数据对象 \n\n> \"canreg\" 是一个包含四个元素的列表，这些元素被命名为 'areacode'、'FBcases'、'SWcases' 和 'POP'，它们是从原始数据的 \"FB\"、\"SW\" 和 \"POP\" 工作表中读取的。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\" \"FBcases\"  \"SWcases\"  \"POP\"     \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(data$SWcases)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 19\n  registr  sex   birthda    trib  occu  marri inciden    topo  morp  beha  grad \n  <chr>    <chr> <date>     <chr> <chr> <chr> <date>     <chr> <chr> <chr> <chr>\n1 1741010… 2     1921-02-18 01    39    2     2014-10-21 C44.5 8010  3     9    \n2 1841010… 1     1935-05-15 01    80    2     2018-07-14 C34.9 8010  3     9    \n3 1841010… 2     1941-02-16 01    29    2     2015-04-02 C34.9 8000  3     9    \n4 1841010… 1     1952-07-06 01    90    2     2018-04-17 C61.9 8140  3     3    \n5 1841010… 1     1947-08-21 01    85    2     2017-11-13 C16.3 8140  3     9    \n6 1841010… 1     1941-08-16 01    29    2     2015-12-23 C73.9 8050  3     9    \n# ℹ 8 more variables: basi <chr>, icd10 <chr>, autoicd10 <chr>,\n#   lastcontact <dttm>, status <chr>, caus <chr>, deathda <date>,\n#   deadplace <chr>\n```\n\n\n:::\n:::\n\n\n\n\n\n## canreg类数据对象 \n\n> \"canreg\" 是一个包含四个元素的列表，这些元素被命名为 'areacode'、'FBcases'、'SWcases' 和 'POP'，它们是从原始数据的 \"FB\"、\"SW\" 和 \"POP\" 工作表中读取的。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\" \"FBcases\"  \"SWcases\"  \"POP\"     \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(data$POP)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n   year   sex agegrp   rks\n  <int> <int> <fct>  <int>\n1  2021     1 0~      3850\n2  2021     1 1~     14405\n3  2021     1 5~     15176\n4  2021     1 10~    16227\n5  2021     1 15~    18685\n6  2021     1 20~    27799\n```\n\n\n:::\n:::\n\n\n\n\n\n## 转换canreg类数据为fbswicd类\n\n> count_canreg()函数可以把'canreg'类数据转换为'fbswicd'类数据，'fbswicd'类数据是一个按照指定分类方法和格式转换的汇总数据，当原始数据量很大时，可以节省存储空间和运行效率。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfbsw <- count_canreg(data, cancer_type = \"big\")\nclass(fbsw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"fbswicd\" \"list\"   \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(fbsw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\" \"fbswicd\"  \"sitemorp\" \"pop\"     \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(fbsw$fbswicd, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    year   sex agegrp cancer   fbs   sws    mv    ub   sub m8000   dco\n   <int> <int> <fctr>  <int> <int> <int> <int> <int> <int> <int> <int>\n1:  2021     1   0 岁     60     3     0     2     1     1     1     0\n2:  2021     1   0 岁     61     3     0     2     1     1     1     0\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(fbsw$sitemorp, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    year   sex cancer              site               morp\n   <int> <int>  <int>            <list>             <list>\n1:  2021     2    115 <data.frame[3x2]>  <data.frame[9x2]>\n2:  2021     2    114 <data.frame[8x2]> <data.frame[18x2]>\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(fbsw$pop, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    year   sex agegrp   rks\n   <int> <int> <fctr> <int>\n1:  2021     1   0 岁  3850\n2:  2021     1 1-4 岁 14405\n```\n\n\n:::\n:::\n\n\n\n\n\n## 提取canreg类数据摘要信息\n> summary 函数可以快速提取'canreg'类数据摘要，比如发病率、死亡率、死亡发病比、数据格式检查情况、人口数据检查情况、基本变量符合情况等，从而为多登记处的筛选提供数据。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsumm <- summary(data)\nclass(summ)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"summary\" \"list\"   \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(summ)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"areacode\"         \"rks\"              \"fbs\"              \"inci\"            \n [5] \"sws\"              \"mort\"             \"mi\"               \"mv\"              \n [9] \"dco\"              \"rks_year\"         \"inci_vars\"        \"miss_r_vars_inci\"\n[13] \"mort_vars\"        \"miss_r_vars_mort\"\n```\n\n\n:::\n\n```{.r .cell-code}\npurrr::pluck(summ, \"mi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.38\n```\n\n\n:::\n\n```{.r .cell-code}\npurrr::pluck(summ, \"inci\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 373.15\n```\n\n\n:::\n\n```{.r .cell-code}\npurrr::pluck(summ, \"mort\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 142\n```\n\n\n:::\n:::\n\n\n\n\n## 标化率的计算\n> create_asr 函数能够根据提供的标准人口计算年龄标准化率、截缩率和累积率，它还可以估计标化率的方差和95%置信区间。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# list all available standard population\nls_std_vars()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  Vars    Description                           \n  <chr>   <chr>                                 \n1 cn64    Standard population in Chinese in 1964\n2 cn82    Standard population in Chinese in 1982\n3 cn2000  Standard population in Chinese in 2000\n4 wld85   Segi's world standard population      \n5 wld2000 World standard population in 2000     \n```\n\n\n:::\n\n```{.r .cell-code}\n# calculate asr using the create_asr() function\ncreate_asr(fbsw, event = fbs, year, sex, cancer, std = c(\"cn2000\", \"wld85\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 56 × 11\n    year   sex cancer no_cases     cr asr_cn2000 asr_wld85 truncr_cn2000\n   <int> <int>  <int>    <int>  <dbl>      <dbl>     <dbl>         <dbl>\n 1  2021     1     60     1069 327.       266.      267.          436.  \n 2  2021     1     61     1050 321.       262.      263.          429.  \n 3  2021     1    101       18   5.50       4.68      4.84         10.4 \n 4  2021     1    102        5   1.53       1.23      1.45          2.63\n 5  2021     1    103       47  14.4       10.8      10.3          12.0 \n 6  2021     1    104       65  19.9       15.6      16.0          21.9 \n 7  2021     1    105       87  26.6       21.0      21.7          32.9 \n 8  2021     1    106       84  25.7       20.7      21.7          39.4 \n 9  2021     1    107       21   6.41       5.12      5.57          9.64\n10  2021     1    108       28   8.55       6.82      7.14         10.1 \n# ℹ 46 more rows\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n## 标化率的计算\n> 一些后处理函数如drop_total, drop_others, and add_labels 可以对生成的数据进行癌种筛选、添加标签等操作。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncreate_asr(fbsw, event = fbs, year, sex, cancer) |> \n  drop_total() |> drop_others() |> \n  add_labels(lang = \"en\", label_type = \"abbr\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 48 × 13\n    year sex   cancer site             icd10 no_cases    cr asr_cn2000 asr_wld85\n   <int> <fct>  <int> <fct>            <fct>    <int> <dbl>      <dbl>     <dbl>\n 1  2021 Male     101 Oral Cavity & P… C00-…       18  5.50       4.68      4.84\n 2  2021 Male     102 Nasopharynx      C11          5  1.53       1.23      1.45\n 3  2021 Male     103 Esophagus        C15         47 14.4       10.8      10.3 \n 4  2021 Male     104 Stomach          C16         65 19.9       15.6      16.0 \n 5  2021 Male     105 Colorectum       C18-…       87 26.6       21.0      21.7 \n 6  2021 Male     106 Liver            C22         84 25.7       20.7      21.7 \n 7  2021 Male     107 Gallbladder      C23-…       21  6.41       5.12      5.57\n 8  2021 Male     108 Pancreas         C25         28  8.55       6.82      7.14\n 9  2021 Male     109 Larynx           C32         15  4.58       3.72      3.97\n10  2021 Male     110 Lung             C33-…      230 70.2       57.1      59.1 \n# ℹ 38 more rows\n# ℹ 4 more variables: truncr_cn2000 <dbl>, truncr_wld85 <dbl>, cumur <dbl>,\n#   prop <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n## 质量控制指标计算\n> create_quality函数可以基于“canreg”类数据或“fbswicd”类数据计算质量指标，包括癌症病例数、粗发病率、死亡率、死亡发病比、形态学诊断的病例比例、DCO（死亡证明诊断病例比例）、UB%等。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate quality indicators based on 'canreg' data\ncreate_quality(data, year, sex, cancer) |> filter(!cancer == 0) |> \n  add_labels(lang = \"en\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 56 × 16\n    year sex   cancer site    icd10    rks   fbs    fbl   sws    swl    mi    mv\n   <int> <fct>  <int> <fct>   <fct>  <int> <int>  <dbl> <int>  <dbl> <dbl> <dbl>\n 1  2021 Male      60 All Ca… ALL   327403  1069 327.     559 171.    0.52  76.8\n 2  2021 Male      61 All Ca… ALLb… 327403  1050 321.     553 169.    0.53  76.6\n 3  2021 Male     101 Oral C… C00-… 327403    18   5.5     10   3.05  0.56  55.6\n 4  2021 Male     102 Nasoph… C11   327403     5   1.53     4   1.22  0.8   40  \n 5  2021 Male     103 Esopha… C15   327403    47  14.4     35  10.7   0.74  87.2\n 6  2021 Male     104 Stomach C16   327403    65  19.8     55  16.8   0.85  73.8\n 7  2021 Male     105 Conlon… C18-… 327403    87  26.6     55  16.8   0.63  77.0\n 8  2021 Male     106 Liver   C22   327403    84  25.7     77  23.5   0.92  66.7\n 9  2021 Male     107 Gallbl… C23-… 327403    21   6.41    16   4.89  0.76  85.7\n10  2021 Male     108 Pancre… C25   327403    28   8.55    28   8.55  1     50  \n# ℹ 46 more rows\n# ℹ 4 more variables: dco <dbl>, ub <dbl>, sub <dbl>, m8000 <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n## 质量控制指标计算\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate quality indicators based on 'fbswicd' data\ncreate_quality(fbsw, year, sex) |>\n  add_labels(lang = \"en\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 16\n   year sex    cancer site      icd10    rks   fbs   fbl   sws   swl    mi    mv\n  <int> <fct>   <dbl> <fct>     <fct>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl>\n1  2021 Male       60 All Canc… ALL   327403  1069  327.   559  171.  0.52  76.8\n2  2021 Female     60 All Canc… ALL   355707  1415  398.   405  114.  0.29  84.8\n# ℹ 4 more variables: dco <dbl>, ub <dbl>, sub <dbl>, m8000 <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\ncreate_quality(fbsw, cancer) |>\n  filter(!cancer == 0) |> \n  add_labels(lang = \"en\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 28 × 16\n    year sex   cancer site    icd10    rks   fbs    fbl   sws    swl    mi    mv\n   <dbl> <fct>  <int> <fct>   <fct>  <int> <int>  <dbl> <int>  <dbl> <dbl> <dbl>\n 1  9000 Total     60 All Ca… ALL   683110  2484 364.     964 141.    0.39  81.4\n 2  9000 Total     61 All Ca… ALLb… 683110  2451 359.     950 139.    0.39  81.2\n 3  9000 Total    101 Oral C… C00-… 683110    26   3.81    13   1.9   0.5   57.7\n 4  9000 Total    102 Nasoph… C11   683110     7   1.02     5   0.73  0.71  57.1\n 5  9000 Total    103 Esopha… C15   683110    66   9.66    46   6.73  0.7   86.4\n 6  9000 Total    104 Stomach C16   683110   101  14.8     79  11.6   0.78  71.3\n 7  9000 Total    105 Conlon… C18-… 683110   181  26.5    103  15.1   0.57  81.2\n 8  9000 Total    106 Liver   C22   683110   125  18.3    100  14.6   0.8   68  \n 9  9000 Total    107 Gallbl… C23-… 683110    44   6.44    31   4.54  0.7   86.4\n10  9000 Total    108 Pancre… C25   683110    46   6.73    57   8.34  1.24  43.5\n# ℹ 18 more rows\n# ℹ 4 more variables: dco <dbl>, ub <dbl>, sub <dbl>, m8000 <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n## 年龄别率计算\n> create_age_rate 函数可以基于“canreg”类数据或“fbswicd”类数据计算年龄别率，并输出为不同的格式（长数据或宽数据）。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate age specific rate from 'canreg' data.\ncreate_age_rate(data, year, sex, cancer, format = \"long\") |> \n  filter(!cancer == 0) |> \n  arrange(year, sex, cancer, agegrp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,064 × 6\n    year   sex cancer agegrp   cases  rate\n   <int> <int>  <int> <fct>    <int> <dbl>\n 1  2021     1     60 0 岁         3  77.9\n 2  2021     1     60 1-4 岁       3  20.8\n 3  2021     1     60 5-9 岁       5  32.9\n 4  2021     1     60 10-14 岁     0   0  \n 5  2021     1     60 15-19 岁     2  10.7\n 6  2021     1     60 20-24 岁     5  18.0\n 7  2021     1     60 25-29 岁    14  38.7\n 8  2021     1     60 30-34 岁    38 130. \n 9  2021     1     60 35-39 岁    36 121. \n10  2021     1     60 40-44 岁    60 196. \n# ℹ 1,054 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## 年龄别率计算\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate age specific rate from 'fbswicd' data.\ncreate_age_rate(fbsw, year, sex, cancer, format = \"wide\") |>\n  filter(!cancer == 0) |> \n  add_labels(lang = \"en\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 56 × 45\n    year sex   cancer site       icd10    f0    f1    f2    f3    f4    f5    f6\n   <int> <fct>  <int> <fct>      <fct> <int> <int> <int> <int> <int> <int> <int>\n 1  2021 Male      60 All Cance… ALL    1069     3     3     5     0     2     5\n 2  2021 Male      61 All Cance… ALLb…  1050     3     3     5     0     2     5\n 3  2021 Male     101 Oral Cavi… C00-…    18     0     0     0     0     0     0\n 4  2021 Male     102 Nasophary… C11       5     0     0     0     0     0     0\n 5  2021 Male     103 Esophagus  C15      47     0     0     0     0     0     0\n 6  2021 Male     104 Stomach    C16      65     0     0     0     0     0     0\n 7  2021 Male     105 Conlon, R… C18-…    87     0     0     0     0     0     0\n 8  2021 Male     106 Liver      C22      84     0     1     0     0     0     0\n 9  2021 Male     107 Gallbladd… C23-…    21     0     0     0     0     0     0\n10  2021 Male     108 Pancreas   C25      28     0     0     0     0     0     0\n# ℹ 46 more rows\n# ℹ 33 more variables: f7 <int>, f8 <int>, f9 <int>, f10 <int>, f11 <int>,\n#   f12 <int>, f13 <int>, f14 <int>, f15 <int>, f16 <int>, f17 <int>,\n#   f18 <int>, f19 <int>, r0 <dbl>, r1 <dbl>, r2 <dbl>, r3 <dbl>, r4 <dbl>,\n#   r5 <dbl>, r6 <dbl>, r7 <dbl>, r8 <dbl>, r9 <dbl>, r10 <dbl>, r11 <dbl>,\n#   r12 <dbl>, r13 <dbl>, r14 <dbl>, r15 <dbl>, r16 <dbl>, r17 <dbl>,\n#   r18 <dbl>, r19 <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n# 批量处理多登记处数据\n## 批量读取多个原始数据\n> read_canreg 函数可以读取多个原始数据并将其转换为'canregs'类数据，其实'canregs' 类数据是一个包含多个元素的列表，每个元素是一个'canreg'类数据。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiles <- list.files(\"~/website/slides/outputs\", full.names = TRUE)\n# read the first 10 raw files in outputs folder into 'canregs'\ndata <- read_canreg(files[1:10])\nclass(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"canregs\" \"list\"   \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"410102\" \"410103\" \"410104\" \"410105\" \"410123\" \"410185\" \"410224\" \"410302\"\n [9] \"410303\" \"410304\"\n```\n\n\n:::\n:::\n\n\n\n\n## 提取canregs类数据摘要信息\n\n> summary 函数可以快速地计算'canregs'类数据的摘要信息，并通过cr_select函数对指定的条件进行筛选。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsumm <- summary(data)\nnames(summ)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"410102\" \"410103\" \"410104\" \"410105\" \"410123\" \"410185\" \"410224\" \"410302\"\n [9] \"410303\" \"410304\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsumm1 <- cr_select(summ, inci > 300, mi > 0.4)\nnames(summ1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410302\" \"410303\" \"410304\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsumm2 <- cr_select(summ, inci > 290 | mort > 150)\nnames(summ2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\" \"410103\" \"410104\" \"410105\" \"410302\" \"410303\" \"410304\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsumm3 <- cr_select(summ, index = c(\"410102\", \"410303\"))\nnames(summ3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\" \"410303\"\n```\n\n\n:::\n:::\n\n\n\n\n## 筛选canregs类数据\n> cr_select 函数可以通过指定一个或多个条件对'carengs', 'fbswicds', 'asrs', and, 'summaries'类数据进行筛选和过滤，从而满足通过一定条件对登记处数据筛选的功能。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 <- data |> cr_select(index = names(summ2))\nnames(data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\" \"410103\" \"410104\" \"410105\" \"410302\" \"410303\" \"410304\"\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(summ2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\" \"410103\" \"410104\" \"410105\" \"410302\" \"410303\" \"410304\"\n```\n\n\n:::\n:::\n\n\n\n\n## 转换canregs类数据为fbswicds类数据\n> count_canreg 函数可以转换 'canregs' 类数据为'fbswicds'类数据, 'fbswicds'类数据是一个列表，列表的每个元素是一个'fbswicd'类数据，其可以作为create_asr, create_quality, create_sheet, 等函数的输入数据。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfbsw <- count_canreg(data2)\nclass(fbsw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"fbswicds\" \"list\"    \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(fbsw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"410102\" \"410103\" \"410104\" \"410105\" \"410302\" \"410303\" \"410304\"\n```\n\n\n:::\n:::\n\n\n\n\n\n## 标化率计算\n> create_asr 函数可以基于'canregs'或着'fbswicds'类数据计算年龄标化率. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nasrs <- create_asr(fbsw, event = fbs, year, sex)\nclass(asrs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"asrs\" \"list\"\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(asrs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$`410102`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60     1069  327.       266.      267.          436.\n2  2021     2     60     1415  398.       319.      299.          565.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n\n$`410103`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60     1190  362.       242.      237.          380.\n2  2021     2     60     1469  409.       289.      272.          539.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n\n$`410104`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60      720  316.       244.      239.          398.\n2  2021     2     60      862  341.       272.      258.          500.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n\n$`410105`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60     1816  392.       286.      273.          429.\n2  2021     2     60     2334  461.       344.      319.          610.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n\n$`410302`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60      289  348.       225.      222.          345.\n2  2021     2     60      272  315.       188.      182.          343.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n\n$`410303`\n# A tibble: 2 × 11\n   year   sex cancer no_cases    cr asr_cn2000 asr_wld85 truncr_cn2000\n  <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>         <dbl>\n1  2021     1     60      625  383.       278.      310.          280.\n2  2021     2     60      596  369.       230.      222.          354.\n# ℹ 3 more variables: truncr_wld85 <dbl>, cumur <dbl>, prop <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n## 合并年龄标化率(asrs)\n> cr_merge 函数可以合并 'carengs', 'fbswicds', 'asrs', 和 'qualities'类数据为 'canreg', 'fbswicd', 'asr', 和 'quality' 类数据.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nasrs2 <- asrs |> cr_merge()\nhead(asrs2, c(6,8))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 8\n  areacode  year   sex cancer no_cases    cr asr_cn2000 asr_wld85\n     <int> <int> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>\n1   410102  2021     1     60     1069  327.       266.      267.\n2   410102  2021     2     60     1415  398.       319.      299.\n3   410103  2021     1     60     1190  362.       242.      237.\n4   410103  2021     2     60     1469  409.       289.      272.\n5   410104  2021     1     60      720  316.       244.      239.\n6   410104  2021     2     60      862  341.       272.      258.\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(asrs2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"areacode\"      \"year\"          \"sex\"           \"cancer\"       \n [5] \"no_cases\"      \"cr\"            \"asr_cn2000\"    \"asr_wld85\"    \n [9] \"truncr_cn2000\" \"truncr_wld85\"  \"cumur\"         \"prop\"         \n```\n\n\n:::\n:::\n\n\n\n\n## 质量控制指标计算\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqualities <- create_quality(fbsw, year, sex)\nqualities\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$`410102`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 327403  1069  327.   559  171.  0.52  76.8  1.5   1.78\n2  2021     2     60 355707  1415  398.   405  114.  0.29  84.8  0.85  1.98\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\n$`410103`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 328415  1190  362.   672  205.  0.56  73.9  0.67  2.18\n2  2021     2     60 358941  1469  409.   408  114.  0.28  77.9  1.09  2.11\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\n$`410104`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 227511   720  316.   369 162.   0.51  82.2  0.56  1.81\n2  2021     2     60 253077   862  341.   252  99.6  0.29  82.2  0.35  1.28\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\n$`410105`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 462738  1816  392.   792  171.  0.44  77.8  0.72  1.6 \n2  2021     2     60 506456  2334  461.   553  109.  0.24  80.9  0.21  1.63\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\n$`410302`\n# A tibble: 2 × 14\n   year   sex cancer   rks   fbs   fbl   sws   swl    mi    mv   dco    ub   sub\n  <int> <int>  <dbl> <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 83010   289  348.   153  184.  0.53  69.9  0     1.04  65.7\n2  2021     2     60 86359   272  315.   103  119.  0.38  75.4  0.74  0.74  72.1\n# ℹ 1 more variable: m8000 <dbl>\n\n$`410303`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60 163005   625  383.   412  253.  0.66  76.8  1.12  0.96\n2  2021     2     60 161724   596  369.   252  156.  0.42  84.4  1.51  2.52\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\n$`410304`\n# A tibble: 2 × 14\n   year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco    ub\n  <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl> <dbl>\n1  2021     1     60  99735   427  428.   232  233.  0.54  71.4  2.81  2.81\n2  2021     2     60 100963   353  350.   147  146.  0.42  79.3  2.55  1.13\n# ℹ 2 more variables: sub <dbl>, m8000 <dbl>\n\nattr(,\"class\")\n[1] \"qualities\" \"list\"     \n```\n\n\n:::\n:::\n\n\n\n\n## 合并质量控制指标\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqualities2 <- qualities |> cr_merge()\nhead(qualities2,c(6,12))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 12\n  areacode  year   sex cancer    rks   fbs   fbl   sws   swl    mi    mv   dco\n     <int> <int> <int>  <dbl>  <int> <int> <dbl> <int> <dbl> <dbl> <dbl> <dbl>\n1   410102  2021     1     60 327403  1069  327.   559 171.   0.52  76.8  1.5 \n2   410102  2021     2     60 355707  1415  398.   405 114.   0.29  84.8  0.85\n3   410103  2021     1     60 328415  1190  362.   672 205.   0.56  73.9  0.67\n4   410103  2021     2     60 358941  1469  409.   408 114.   0.28  77.9  1.09\n5   410104  2021     1     60 227511   720  316.   369 162.   0.51  82.2  0.56\n6   410104  2021     2     60 253077   862  341.   252  99.6  0.29  82.2  0.35\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(qualities2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"areacode\" \"year\"     \"sex\"      \"cancer\"   \"rks\"      \"fbs\"     \n [7] \"fbl\"      \"sws\"      \"swl\"      \"mi\"       \"mv\"       \"dco\"     \n[13] \"ub\"       \"sub\"      \"m8000\"   \n```\n\n\n:::\n:::\n\n\n\n\n# 数据合并和转换\n## 显示肿瘤登记处属性\n> tidy_areacode 函数可以显示肿瘤登记处属性，并根据属性值进行分组。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nattributes <- tidy_areacode(\"410302\")\nnames(attributes)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"areacode\"  \"registry\"  \"province\"  \"city\"      \"area_type\" \"region\"   \n```\n\n\n:::\n:::\n\n\n\n\n> 可以使用**write_registry**, or **write_area_type**函数修改登记处属性。\n\n## 转换'fbswicds'为'fbswicd'\n> reframe_fbswicd函数可以根据登记处属性如'area_type', 'registry', 'province'把'fbswicds'转换为'fbswicd'。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_canreg(files[1:10])\nfbsws <- count_canreg(data)\nclass(fbsws)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"fbswicds\" \"list\"    \n```\n\n\n:::\n\n```{.r .cell-code}\nnames(fbsws)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"410102\" \"410103\" \"410104\" \"410105\" \"410123\" \"410185\" \"410224\" \"410302\"\n [9] \"410303\" \"410304\"\n```\n\n\n:::\n\n```{.r .cell-code}\nfbsw <- cr_reframe(fbsws, \"area_type\")\nclass(fbsw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"fbswicds\" \"list\"    \n```\n\n\n:::\n:::\n\n\n\n\n## 基于转换后的fbswicd计算标化率\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nasr <- create_asr(fbsw, sex) |> \n  cr_merge()\nhead(asr, c(6, 8))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 8\n  areacode  year   sex cancer no_cases    cr asr_cn2000 asr_wld85\n     <int> <dbl> <int>  <dbl>    <int> <dbl>      <dbl>     <dbl>\n1   910000  9000     1     60     6136  363.       253.      248.\n2   910000  9000     2     60     7301  400.       288.      270.\n3   920000  9000     1     60     2676  233.       172.      168.\n4   920000  9000     2     60     2817  254.       186.      176.\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(asr)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"areacode\"      \"year\"          \"sex\"           \"cancer\"       \n [5] \"no_cases\"      \"cr\"            \"asr_cn2000\"    \"asr_wld85\"    \n [9] \"truncr_cn2000\" \"truncr_wld85\"  \"cumur\"         \"prop\"         \n```\n\n\n:::\n:::\n\n\n\n\n# 肿瘤登记数据的可视化\n## 绘制金字塔图\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(showtext)\nshowtext_auto()\ndata <- read_canreg(files[10])\nfbsw <- count_canreg(data)\ndraw_pyramid(fbsw, show_value = F)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-24-1.png){width=960}\n:::\n:::\n\n\n\n\n## 绘制条形图\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nasr <- create_asr(fbsw,year,sex,cancer) |> drop_total() |>\n  drop_others() |> add_labels(label_type = \"abbr\", lang = \"en\")\ndraw_barchart(asr, plot_var =cr, cate_var = site,\n              side_label = c(\"Male\",\"Female\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-25-1.png){width=960}\n:::\n:::\n\n\n\n\n\n## 绘制分组条形图\n\n\n\n\n::: {.cell .fig-column-page-right}\n\n```{.r .cell-code}\nlibrary(dplyr)\nasr1 <- create_asr(fbsw,year,sex,cancer,event = fbs) |> mutate(type=\"incidence\")\nasr2 <- create_asr(fbsw,year,sex,cancer,event = sws) |> mutate(type=\"mortality\")\nasr <- bind_rows(asr1, asr2) |> drop_others() |> drop_total() |> \n  add_labels(label_type = \"abbr\",lang = \"en\")\ndraw_barchart(asr, plot_var =cr, cate_var = site,group_var = type,\n              side_label = c(\"Male\",\"Female\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-26-1.png){width=960}\n:::\n:::\n\n\n\n\n\n## 绘制线图\n\n\n\n\n::: {.cell .fig-column-page-right}\n\n```{.r .cell-code}\nagerate <- create_age_rate(fbsw,sex) |> add_labels(lang=\"en\")\nnames(agerate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"year\"   \"sex\"    \"cancer\" \"site\"   \"icd10\"  \"agegrp\" \"cases\"  \"rate\"  \n```\n\n\n:::\n\n```{.r .cell-code}\ndraw_line(agerate, agegrp, rate, sex)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-27-1.png){width=960}\n:::\n:::\n\n\n\n\n\n# 自动化报告 {background=\"lightblue\"}\n\n\n## 为什么?{.smaller}\n\n> 肿瘤登记处的主要目标之一就是产生肿瘤发病、死亡、生存相关的统计指标, 并通过一定的渠道发布数据,促进数据的共享和利用（专业人员和大众）,从而促进癌症防控政策的产生。\n\n- 了解疾病负担\n- 支持病因学研究\n- 预后研究\n- 为癌症防控政策提供基础数据\n\n\n## 肿瘤登记报告流程{.smaller}\n\n\n\n```{mermaid}\n%%| label: fig-report\n%%| fig-cap: 肿瘤登记报告流程\n%%| fig-align: center\nflowchart TD\n  A(数据来源单位) --> B(县区级登记处)\n  B --> C(市级登记处)\n  C --> D(省级质量控制)\n  D --> B\n  B --> A\n  D --> C\n  D --> F(综合评估)\n  F --> G(年报撰写及发布)\n```\n\n\n\n## 年报该如何撰写?\n>把统计分析数据转换为文字的过程。\n\n\n\n```{mermaid}\nflowchart LR\n  A(统计分析) --> B(制作表格)\n  B --> C(绘制统计图)\n  C --> D(专家撰写)\n  D --> E(初稿)\n    E --> F(审核定版)\n```\n\n\n\n\n::: columns\n::: {.column width=\"40%\"}\n::: callout-tip\n## 年报特点\n- 客观描述\n- 要求文字描述风格的一致性\n- 有图有表\n- 无讨论，无观点\n- 需要专家码字\n:::\n:::\n\n::: {.column width=\"40%\"}\n::: callout-important\n## 自动化？\n- Scientific writing？\n- 可重复性报告\n- Rmarkdown\n- Quarto\n:::\n:::\n:::\n\n## 可重复性报告技术\n>基于现有年报的特点,以及随着可重复性报告技术的成熟,可以实现自动化撰写的需求?\n\n:::{.callout-note}\n## 思路\n利用Bookdown包把统计结果进行展现，包括文字描述和可视化展现(各种统计图表)\n:::\n\n\n## 可重复性报告技术\n![](../2023-9-23-rural-canreg/images/report.jpg)\n\n\n## 可重复性报告技术{.smaller}\n> Bookdown程序由按照章节区分的Rmd文件组成，每个Rmd文件可以输出相应章节的文字描述，从而形成最终的文本。\n\n::: {.columns}\n:::{.column width=\"30%\"}\n1. index.Rmd\n1. 01-summary.Rmd\n1. 02-method.Rmd\n1. 03-quality.Rmd\n1. 04-total_cancer.Rmd\n1. 05-eachsite.Rmd\n:::\n:::{.column width=\"20%\"}\n- 行内代码插入数据\n- 文字描述\n:::\n:::{.column width=\"50%\"}\n![](https://cdn.jsdelivr.net/gh/gigu003/db/images/quality/codes.jpg){width='75%' fig-align=\"center\"}\n\n:::\n:::\n\n## 可重复性报告技术{.smaller}\n\n![](https://cdn.jsdelivr.net/gh/gigu003/db/images/quality/letters.jpg){width='75%' fig-align=\"center\"}\n\n## 表格如何实现？\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata<-inciden\nheader<-data.frame(\n    col_keys=colnames(data),\n    second=c(\"地区\",\"性别\",\"发病数\",\"发病率\",\"中标率\",\"世标率\",\"累积率\\n0-74(%)\"))\ndata%>%flextable()%>%\n  set_header_df( mapping = header, key = \"col_keys\" )%>%\n  compose(j=4,value=as_paragraph(\"发病率\\n(1/10\",as_sup(\"5\"),\")\"),part=\"header\")%>%\n  compose(j=5,value=as_paragraph(\"中标率\\n(1/10\",as_sup(\"5\"),\")\"),part=\"header\")%>%\n  compose(j=6,value=as_paragraph(\"世标率\\n(1/10\",as_sup(\"5\"),\")\"),part=\"header\")%>%\n  colformat_num(j=4:7,digits = 5.2)%>%\n  set_caption(caption= paste(year.data,\"年河南省肿瘤登记地区恶性肿瘤（C00-C96）发病主要指标\",\"\"))%>% \n  align(align=\"center\",part=\"all\")%>%\n  bold(bold=TRUE,part=\"header\")%>%\n  width(j=1:2,width=0.5)%>%\n  width(j=3:7,width=1.0)%>%\n  theme_booktabs()\n```\n:::\n\n\n\n\n## 表格如何实现？\n![](https://cdn.jsdelivr.net/gh/gigu003/db/images/quality/tables.jpg){fig-align=\"center\"}\n\n## 批量化生成各章节统计图\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyearpub<-2023\nreport<-haven::read_sas(\"./report.sas7bdat\")\nareacode1 <- c(\"410902\",\"411202\",\"411303\",\"411502\",\"419001\",\"411002\")\nareacode2 <- c(\"410901\",\"411001\",\"411201\",\"411301\",\"411501\")\nreport <-report%>%\n  filter(city %in% c(\"11\",\"2\",\"33\")|areacode %in% areacode1,\n         !(areacode %in% areacode2))%>%\n  mutate(year = as.numeric(year),\n         city = as.numeric(city))\nsource(\"./rscripts/gen_annual_report_plot.R\")\n```\n:::\n\n\n\n## 批量化生成各章节统计图{.smaller}\n\n![](../2023-9-23-rural-canreg/images/charts.jpg){fig-align=\"center\"}\n\n\n## 生成年报只需一次点击 {.smaller}\n> 大约需要一分钟的时间!!!\n\n::: {.columns}\n::: {.column width=\"30%\"}\n- 一次点击Build\n- 同时输出多种形式\n  - Word\n  - PDF\n  - Epub\n  - 网页\n:::\n\n::: {.column width=\"70%\"}\n![](https://cdn.jsdelivr.net/gh/gigu003/db/images/quality/gen-bookk.gif)\n:::\n:::\n\n## 线上发布{.smaller}\n> 在线发布的年报更容易传播和共享\n\n\n\n::: {.cell}\n<iframe src=\"https://chenq.site/report/2021/\" width=\"960\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\n\n## 现有方法\n\n::: columns\n::: {.column width=\"50%\"}\n::: callout-tip\n## 不足之处\n- 可移植性不足\n- 需要了解一点编程知识\n- 整合性不足\n:::\n:::\n\n::: {.column width=\"50%\"}\n::: callout-important\n## 待开发\n- R包\n- 输出Fact Sheet（按照癌种、人群）\n:::\n:::\n:::\n\n## 现有肿瘤登记年报的特点{.smaller}\n> 随着肿瘤登记处数量的增加以及数据质量的提升,国家及大部分省份开始发布国家级或省级的肿瘤登记年报。\n\n- 以传统书籍的形式出版\n- 以白皮书的形式发布报告\n- 把传统书籍搬到线上（线上年报）\n- 价格较高\n- 不利于数据共享和传播\n\n> 我们真的需要每年发布纸质年报吗？\n\n\n# 谢谢关注！{.no-auto-agenda}\n\n\n\n::: {.cell}\n<style type=\"text/css\">\nfigcaption {\n  margin: auto;\n  text-align: center;\n}\n</style>\n:::\n\n\n\n::: {layout-ncol=3}\n![所有幻灯片](https://cdn.jsdelivr.net/gh/gigu003/db/images/slides.png)\n\n![微信公众号](https://cdn.jsdelivr.net/gh/gigu003/db/images/wechat.jpg)\n\n![个人网站](https://cdn.jsdelivr.net/gh/gigu003/db/images/website.png)\n\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}